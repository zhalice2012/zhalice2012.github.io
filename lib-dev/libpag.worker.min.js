!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).libpag={})}(this,(function(e){"use strict";var t=(e=>(e.PAGInit="PAGInit",e.PAGView_init="PAGView.init",e.PAGView_duration="PAGView.duration",e.PAGView_play="PAGView.play",e.PAGView_pause="PAGView.pause",e.PAGView_stop="PAGView.stop",e.PAGView_setRepeatCount="PAGView.setRepeatCount",e.PAGView_getProgress="PAGView.getProgress",e.PAGView_currentFrame="PAGView.currentFrame",e.PAGView_setProgress="PAGView.setProgress",e.PAGView_scaleMode="PAGView.scaleMode",e.PAGView_setScaleMode="PAGView.setScaleMode",e.PAGView_flush="PAGView.flush",e.PAGView_getDebugData="PAGView.getDebugData",e.PAGView_destroy="PAGView.destroy",e.PAGFile_load="PAGFile.load",e.PAGFile_getTextData="PAGFile.getTextData",e.PAGFile_replaceText="PAGFile.replaceText",e.PAGFile_replaceImage="PAGFile.replaceImage",e.PAGFile_destroy="PAGFile.destroy",e.PAGImage_fromSource="PAGImage.fromSource",e.PAGImage_destroy="PAGImage.destroy",e.VideoReader_constructor="VideoReader.constructor",e.VideoReader_prepare="VideoReader.prepare",e.VideoReader_play="VideoReader.play",e.VideoReader_pause="VideoReader.pause",e.VideoReader_stop="VideoReader.stop",e.VideoReader_getError="VideoReader.getError",e.PAGModule_linkVideoReader="PAGModule.linkVideoReader",e.TextDocument_delete="TextDocument.delete",e))(t||{});let i=0;const s=(e,t,s,r=[])=>new Promise((a=>{const o=(e=>`${e}_${i++}`)(t.name),n=t=>{t.data.name===o&&(e.removeEventListener("message",n),a(s(...t.data.args)))};e.addEventListener("message",n),e.postMessage({name:o,args:t.args},r)}));let r={};const a=(e,t,i,s=!1)=>{var a;t in r||(r[t]=[]),null==(a=r[t])||a.push({node:e,handler:i,capture:s}),e.addEventListener(t,i,s)},o=(e,t,i)=>{var s;t in r&&(null==(s=r[t])||s.filter((({node:t,handler:s})=>t===e&&s===i)).forEach((({node:e,handler:i,capture:s})=>e.removeEventListener(t,i,s))))},n=(e,t)=>{var i,s;t in r&&(null==(i=r[t])||i.filter((({node:t})=>t===e)).forEach((({node:e,handler:i,capture:s})=>e.removeEventListener(t,i,s))),r[t]=null==(s=r[t])?void 0:s.filter((({node:t})=>t!==e)))},l=(null==navigator?void 0:navigator.userAgent)||"",h=/android|adr/i.test(l),d=/(mobile)/i.test(l)&&h;!/(mobile)/i.test(l)&&!d&&/Mac OS X/i.test(l);const c=/(iphone|ipad|ipod)/i.test(l),p=/MicroMessenger/i.test(l),u=/^((?!chrome|android).)*safari/i.test(l)||c,g="function"==typeof globalThis.importScripts;let m;class y{constructor(e){this.bitmap=e}setBitmap(e){this.bitmap&&this.bitmap.close(),this.bitmap=e}}class w{constructor(e){this.bitmap=null,this.isSought=!1,this.isPlaying=!1,this.bitmapImage=new y(null),this.proxyId=e}prepare(e,i){return new Promise((r=>{s(self,{name:t.VideoReader_prepare,args:[this.proxyId,e,i]},(e=>{this.bitmapImage.setBitmap(e),r()}))}))}getVideo(){return this.bitmapImage}onDestroy(){self.postMessage({name:"VideoReader.onDestroy",args:[this.proxyId]})}play(){return new Promise((e=>{s(self,{name:t.VideoReader_play,args:[this.proxyId]},(()=>{e()}))}))}pause(){s(self,{name:t.VideoReader_pause,args:[this.proxyId]},(()=>{}))}stop(){s(self,{name:t.VideoReader_stop,args:[this.proxyId]},(()=>{}))}getError(){return new Promise((e=>{s(self,{name:t.VideoReader_getError,args:[this.proxyId]},(t=>{e(t)}))}))}}const P=(e,t)=>void 0!==t&&e instanceof t,v=e=>new Promise((t=>{const i=()=>{o(e,"canplay",i),clearTimeout(s),t(!0)};a(e,"canplay",i);const s=setTimeout((()=>{o(e,"canplay",i),t(!1)}),1e3)}));class f{constructor(e,t,i,s,r,a=!1){if(this.isSought=!1,this.isPlaying=!1,this.bitmap=null,this.videoEl=null,this.frameRate=0,this.canplay=!1,this.staticTimeRanges=null,this.disablePlaybackRate=!1,this.error=null,this.player=null,this.width=0,this.height=0,this.bitmapCanvas=null,this.bitmapCtx=null,this.seeking=!1,this.pendingSeek=null,this.seekAttempts=0,this.maxSeekAttempts=3,P(e,globalThis.HTMLVideoElement))this.videoEl=e,this.canplay=!0;else{this.videoEl=document.createElement("video"),this.videoEl.style.display="none",this.videoEl.muted=!0,this.videoEl.playsInline=!0,this.videoEl.preload="auto",this.videoEl.width=t,this.videoEl.height=i,v(this.videoEl).then((()=>{this.canplay=!0}));const s=new Blob([e],{type:"video/mp4"});this.videoEl.src=URL.createObjectURL(s),c&&this.videoEl.load()}this.frameRate=s,this.width=t,this.height=i,this.staticTimeRanges=new k(r),(3840<t||3840<i)&&(this.disablePlaybackRate=!0),a||this.linkPlayer(m.currentPlayer)}static async create(e,i,r,a,o){var n;if(g){const l=await new Promise((n=>{const l=e,h=l.buffer.slice(l.byteOffset,l.byteOffset+l.byteLength);s(self,{name:t.VideoReader_constructor,args:[h,i,r,a,o,!0]},(e=>{n(e)}),[h])})),h=new w(l);return null==(n=m.currentPlayer)||n.linkVideoReader(h),h}return new f(e,i,r,a,o)}async prepare(e,t){var i;this.setError(null),this.isSought=!1;const{currentTime:s}=this.videoEl,r=e/this.frameRate;if(0===s&&0===r)if(this.canplay||u){try{await this.play()}catch(e){this.setError(e)}await new Promise((e=>{requestAnimationFrame((()=>{this.pause(),e()}))}))}else await v(this.videoEl);else if(Math.round(r*this.frameRate)===Math.round(s*this.frameRate));else{if(null==(i=this.staticTimeRanges)?void 0:i.contains(e))return void await this.seek(r,!1);if(!(Math.abs(s-r)<1/this.frameRate*3))return this.isSought=!0,void await this.seek(r)}const a=Math.min(Math.max(t,.125),4);if(this.disablePlaybackRate||this.videoEl.playbackRate===a||(this.videoEl.playbackRate=a),this.isPlaying&&this.videoEl.paused)try{await this.play()}catch(e){this.setError(e)}}getVideo(){return this.videoEl}async generateBitmap(){var e,t;return this.bitmapCanvas||(this.bitmapCanvas=new OffscreenCanvas(this.width,this.height),this.bitmapCanvas.width=this.width,this.bitmapCanvas.height=this.height,this.bitmapCtx=this.bitmapCanvas.getContext("2d")),null==(e=this.bitmapCtx)||e.fillRect(0,0,this.width,this.height),null==(t=this.bitmapCtx)||t.drawImage(this.videoEl,0,0,this.width,this.height),this.bitmap=await createImageBitmap(this.bitmapCanvas),this.bitmap}async play(){var e;if(this.videoEl.paused){if(p&&window.WeixinJSBridge&&await new Promise((e=>{window.WeixinJSBridge.invoke("getNetworkType",{},(()=>{e()}),(()=>{e()}))})),"visible"!==document.visibilityState){const e=()=>{"visible"===document.visibilityState&&(this.videoEl&&this.videoEl.play(),window.removeEventListener("visibilitychange",e))};throw window.addEventListener("visibilitychange",e),new Error("The play() request was interrupted because the document was hidden!")}await(null==(e=this.videoEl)?void 0:e.play())}}pause(){var e;this.isPlaying=!1,this.videoEl.paused||null==(e=this.videoEl)||e.pause()}stop(){var e;this.isPlaying=!1,this.videoEl.paused||null==(e=this.videoEl)||e.pause(),this.videoEl.currentTime=0}getError(){return this.error}onDestroy(){this.player&&this.player.unlinkVideoReader(this),n(this.videoEl,"playing"),n(this.videoEl,"timeupdate"),this.videoEl=null,this.bitmapCanvas=null,this.bitmapCtx=null}async seek(e,t=!0){if(this.seeking)return void(this.pendingSeek={targetTime:e,play:t});if(this.seeking=!0,this.seekAttempts++,this.seekAttempts>this.maxSeekAttempts)return console.error("Maximum seek attempts reached, giving up on seek."),this.seeking=!1,void(this.seekAttempts=0);if(!this.videoEl)return console.error("Video element is not initialized."),void(this.seeking=!1);const i=()=>{var e,s;if(o(this.videoEl,"seeked",i),clearTimeout(r),this.seeking=!1,this.seekAttempts=0,t?null==(e=this.videoEl)||e.play().catch((e=>{this.setError(e)})):t||this.videoEl.paused||null==(s=this.videoEl)||s.pause(),this.pendingSeek){const{targetTime:e,play:t}=this.pendingSeek;this.pendingSeek=null,this.seek(e,t)}},s=()=>{o(this.videoEl,"canplay",s),this.videoEl.currentTime=e,a(this.videoEl,"seeked",i)},r=setTimeout((()=>{o(this.videoEl,"canplay",s),o(this.videoEl,"seeked",i),console.warn("Seek operation timed out, retrying..."),this.seeking=!1,this.seek(e,t)}),1e3/this.frameRate*12);this.videoEl.readyState<HTMLMediaElement.HAVE_FUTURE_DATA?a(this.videoEl,"canplay",s):(this.videoEl.currentTime=e,a(this.videoEl,"seeked",i))}setError(e){this.error=e}linkPlayer(e){this.player=e,e&&e.linkVideoReader(this)}}class k{constructor(e){this.timeRanges=e}contains(e){if(0===this.timeRanges.length)return!1;for(let t of this.timeRanges)if(t.start<=e&&e<t.end)return!0;return!1}}const A=e=>new Promise((t=>{const i=new FileReader;i.onload=()=>{t(i.result)},i.onerror=()=>{console.error(i.error.message)},i.readAsArrayBuffer(e)}));function b(e){let t=Object.getOwnPropertyNames(e.prototype).filter((t=>"constructor"!==t&&"function"==typeof e.prototype[t]));const i=(t,i)=>{const s=t[i];t[i]=function(...t){if(!this.isDestroyed)return s.call(this,...t);console.error(`Don't call ${i} of the ${e.name} that is destroyed.`)}};t.forEach((t=>i(e.prototype,t)))}var V=Object.defineProperty,G=Object.getOwnPropertyDescriptor;e.WorkerPAGFile=class{constructor(e,t){this.isDestroyed=!1,this.worker=e,this.key=t}static async load(i,r){const a=await(e=>P(e,globalThis.File)?A(e):P(e,globalThis.Blob)?A(new File([e],"")):P(e,globalThis.ArrayBuffer)?Promise.resolve(e):Promise.resolve(null))(r);if(!a)throw new Error("Initialize PAGFile data type error, please put check data type must to be File ï½œ Blob | ArrayBuffer!");return await s(i,{name:t.PAGFile_load,args:[r]},(t=>new e.WorkerPAGFile(i,t)))}getTextData(e){return s(this.worker,{name:t.PAGFile_getTextData,args:[this.key,e]},(e=>(e.delete=()=>s(this.worker,{name:t.TextDocument_delete,args:[e.key]},(()=>{})),e)))}replaceText(e,i){const r={};for(const e in i)"delete"!==e&&(r[e]=i[e]);return s(this.worker,{name:t.PAGFile_replaceText,args:[this.key,e,r]},(()=>{}))}replaceImage(e,i){return s(this.worker,{name:t.PAGFile_replaceImage,args:[this.key,e,i.key]},(()=>{}))}destroy(){return s(this.worker,{name:t.PAGFile_destroy,args:[this.key]},(()=>{this.isDestroyed=!0}))}},e.WorkerPAGFile=((e,t,i,s)=>{for(var r,a=s>1?void 0:s?G(t,i):t,o=e.length-1;o>=0;o--)(r=e[o])&&(a=(s?r(t,i,a):r(a))||a);return s&&a&&V(t,i,a),a})([b],e.WorkerPAGFile);var E=Object.defineProperty,_=Object.getOwnPropertyDescriptor,R=Object.getOwnPropertySymbols,T=Object.prototype.hasOwnProperty,x=Object.prototype.propertyIsEnumerable,F=(e,t,i)=>t in e?E(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,I=(e,t)=>{for(var i in t||(t={}))T.call(t,i)&&F(e,i,t[i]);if(R)for(var i of R(t))x.call(t,i)&&F(e,i,t[i]);return e};e.WorkerPAGView=class{constructor(e,t){this.isDestroyed=!1,this.worker=e,this.key=t}static init(i,r,a){I(I({},{useScale:!0,useCanvas2D:!1,firstFrame:!0}),a).useScale&&M(r);const o=r.transferControlToOffscreen();return s(i.worker,{name:t.PAGView_init,args:[i.key,o,a]},(t=>new e.WorkerPAGView(i.worker,t)),[o])}duration(){return s(this.worker,{name:t.PAGView_duration,args:[this.key]},(e=>e))}play(){return s(this.worker,{name:t.PAGView_play,args:[this.key]},(()=>{}))}pause(){return s(this.worker,{name:t.PAGView_pause,args:[this.key]},(()=>{}))}stop(){return s(this.worker,{name:t.PAGView_stop,args:[this.key]},(()=>{}))}setRepeatCount(e){return s(this.worker,{name:t.PAGView_setRepeatCount,args:[this.key,e]},(()=>{}))}getProgress(){return s(this.worker,{name:t.PAGView_getProgress,args:[this.key]},(e=>e))}currentFrame(){return s(this.worker,{name:t.PAGView_currentFrame,args:[this.key]},(e=>e))}setProgress(e){return s(this.worker,{name:t.PAGView_setProgress,args:[this.key,e]},(()=>{}))}scaleMode(){return s(this.worker,{name:t.PAGView_scaleMode,args:[this.key]},(e=>e))}setScaleMode(e){return s(this.worker,{name:t.PAGView_setScaleMode,args:[this.key,e]},(()=>{}))}flush(){return s(this.worker,{name:t.PAGView_flush,args:[this.key]},(e=>e))}getDebugData(){return s(this.worker,{name:t.PAGView_getDebugData,args:[this.key]},(e=>e))}destroy(){s(this.worker,{name:t.PAGView_destroy,args:[this.key]},(()=>{this.isDestroyed=!0}))}},e.WorkerPAGView=((e,t,i,s)=>{for(var r,a=s>1?void 0:s?_(t,i):t,o=e.length-1;o>=0;o--)(r=e[o])&&(a=(s?r(t,i,a):r(a))||a);return s&&a&&E(t,i,a),a})([b],e.WorkerPAGView);const M=e=>{const t=(e=>{const t=globalThis.getComputedStyle(e,null),i={width:Number(t.width.replace("px","")),height:Number(t.height.replace("px",""))};if(i.width>0&&i.height>0)return i;{const t={width:Number(e.style.width.replace("px","")),height:Number(e.style.height.replace("px",""))};return t.width>0&&t.height>0?t:{width:e.width,height:e.height}}})(e);e.style.width=`${t.width}px`,e.style.height=`${t.height}px`,e.width=t.width*globalThis.devicePixelRatio,e.height=t.height*globalThis.devicePixelRatio};var S=Object.defineProperty,D=Object.getOwnPropertyDescriptor;e.WorkerPAGImage=class{constructor(e,t){this.isDestroyed=!1,this.worker=e,this.key=t}static async fromSource(i,r){const a=P(r,globalThis.HTMLVideoElement)?r.videoWidth:r.width,o=P(r,globalThis.HTMLVideoElement)?r.videoHeight:r.height,n=new OffscreenCanvas(a,o);n.width=r.width,n.height=r.height;n.getContext("2d").drawImage(r,0,0,r.width,r.height);const l=await createImageBitmap(n);return s(i,{name:t.PAGImage_fromSource,args:[l]},(t=>new e.WorkerPAGImage(i,t)),[l])}destroy(){return s(this.worker,{name:t.PAGImage_destroy,args:[this.key]},(()=>{this.isDestroyed=!0}))}},e.WorkerPAGImage=((e,t,i,s)=>{for(var r,a=s>1?void 0:s?D(t,i):t,o=e.length-1;o>=0;o--)(r=e[o])&&(a=(s?r(t,i,a):r(a))||a);return s&&a&&S(t,i,a),a})([b],e.WorkerPAGImage);const O=[],C=e=>{e.addEventListener("message",(i=>{if(i.data.name.includes(t.VideoReader_constructor)){const t=new f(...i.data.args);return O.push(t),void e.postMessage({name:i.data.name,args:[O.length-1]})}if(i.data.name.includes(t.VideoReader_prepare)){const[t,s,r]=i.data.args;O[t].prepare(s,r).then((()=>{O[t].generateBitmap().then((t=>{e.postMessage({name:i.data.name,args:[t]},[t])}))}))}i.data.name.includes(t.VideoReader_play)&&O[i.data.args[0]].play().then((t=>{e.postMessage({name:i.data.name,args:[t]})})),i.data.name.includes(t.VideoReader_pause)&&O[i.data.args[0]].pause(),i.data.name.includes(t.VideoReader_stop)&&O[i.data.args[0]].stop(),i.data.name.includes(t.VideoReader_getError)&&e.postMessage({name:i.data.name,args:[O[i.data.args[0]].getError()]})}))};e.MAX_ACTIVE_WORKER_CONTEXTS=4,e.createPAGWorker=(e={})=>{let i=e.locateFile?e.locateFile("libpag.js"):"libpag.js";const r={};e.locateFile&&(r.fileUrl=e.locateFile("libpag.wasm"));const a=new Worker(i,e.workerOptions);return s(a,{name:t.PAGInit,args:[r]},(()=>(C(a),a)))},Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=libpag.worker.min.js.map
